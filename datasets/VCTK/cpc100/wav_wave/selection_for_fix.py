"""
train/val/test.txt contain missing or broken file in speechcorpusy's VCTK (not from Edinburgh datashare).
This cause a error, so this script remove these files.
"""
from pathlib import Path
import re


def generate_fixed_data():
    missings = [('361', '131'), ('376', '047'), ('376', '062'), ('376', '281'), ('376', '296'), ('376', '297'), ('376', '298'), ('376', '299'), ('376', '300'), ('376', '301'), ('376', '302'), ('376', '303'), ('376', '304'), ('376', '305'), ('376', '306'), ('376', '307'), ('376', '308'), ('376', '309'), ('376', '310'), ('376', '311'), ('376', '312'), ('376', '313'), ('376', '314'), ('376', '315'), ('376', '316'), ('376', '317'), ('376', '318'), ('376', '319'), ('376', '320'), ('376', '321'), ('376', '322'), ('376', '323'), ('376', '324'), ('376', '325'), ('376', '326'), ('376', '327'), ('376', '328'), ('376', '329'), ('376', '330'), ('376', '331'), ('376', '332'), ('376', '333'), ('376', '334'), ('376', '335'), ('376', '336'), ('376', '337'), ('376', '338'), ('376', '339'), ('376', '340'), ('376', '341'), ('376', '342'), ('376', '343'), ('376', '344'), ('376', '345'), ('376', '346'), ('376', '347'), ('376', '348'), ('376', '349'), ('376', '350'), ('376', '351'), ('376', '352'), ('376', '353'), ('376', '354'), ('376', '355'), ('376', '356'), ('376', '357'), ('376', '358'), ('376', '359'), ('376', '360'), ('376', '361'), ('376', '362'), ('376', '363'), ('376', '364'), ('376', '365'), ('376', '366'), ('376', '367'), ('376', '368'), ('376', '369'), ('376', '370'), ('376', '371'), ('376', '372'), ('376', '373'), ('376', '374'), ('376', '375'), ('376', '376'), ('376', '377'), ('376', '378'), ('376', '379'), ('376', '380'), ('376', '381'), ('376', '382'), ('376', '383'), ('376', '384'), ('376', '385'), ('376', '386'), ('376', '387'), ('376', '388'), ('376', '389'), ('376', '390'), ('376', '391'), ('376', '392'), ('376', '393'), ('376', '394'), ('376', '395'), ('376', '396'), ('376', '397'), ('376', '398'), ('376', '399'), ('376', '400'), ('376', '401'), ('376', '402'), ('376', '403'), ('376', '404'), ('376', '405'), ('376', '406'), ('376', '407'), ('376', '408'), ('376', '409'), ('376', '410'), ('376', '411'), ('376', '412'), ('376', '413'), ('376', '414'), ('376', '415'), ('376', '416'), ('376', '417'), ('376', '418'), ('376', '419'), ('376', '420'), ('376', '421'), ('376', '422'), ('376', '423'), ('376', '424')]
    spk_id_template = re.compile('p(\d{3})_(\d{3})')

    for name in ["train", "val", "test"]:
        rel = "datasets/VCTK/cpc100/wav_wave"
        path_original = Path(f"{rel}/{name}.txt")
        path_target   = Path(f"{rel}/fixed_{name}.txt")

        with open(path_target, mode="a") as f_target:
            with open(path_original) as f_original:
                for line in f_original.readlines():
                    if line[0] == '{':
                        # {"audio": "<path>", "SSL_type: "X X X ...", "duration": 1.9}
                        sample = eval(line.strip())
                        result = spk_id_template.search(sample["audio"])
                        spk_id, uttr_id = result.group(1), result.group(2)
                        if (spk_id, uttr_id) in missings:
                            pass
                        else:
                            f_target.write(line)


def find_missings():
    import re
    from speechcorpusy import load_preset
    # speechcorpus's items
    corpus_items = load_preset("VCTK", root="/content/gdrive/MyDrive/ML_data", download=False).get_identities()
    corpus_items = list(map(lambda item: (item.speaker[6:], item.name), corpus_items))

    # UnitHiFi's items
    spk_id_template = re.compile('p(\d{3})_(\d{3})')
    data_items = []
    for mode in ["train", "val", "test"]:
        path_original = Path(f"datasets/VCTK/cpc100/wav_wave/{mode}.txt")
        with open(path_original) as f_original:
            for line in f_original.readlines():
                if line[0] == '{':
                    # {"audio": "<path>", "SSL_type: "X X X ...", "duration": 1.9}
                    sample = eval(line.strip())
                    result = spk_id_template.search(sample["audio"])
                    spk_id, uttr_id = result.group(1), result.group(2)
                    data_items += [(spk_id, uttr_id)]

    # Find missings
    missings = []
    for data_item in data_items:
        if data_item not in corpus_items:
            missings += [data_item]
    print(missings)
    # missing_train = [('361', '131'), ('376', '422'), ('376', '350'), ('376', '403'), ('376', '371'), ('376', '344'), ('376', '327'), ('376', '333'), ('376', '399'), ('376', '380'), ('376', '365'), ('376', '349'), ('376', '417'), ('376', '312'), ('376', '368'), ('376', '062'), ('376', '319'), ('376', '296'), ('376', '411'), ('376', '377'), ('376', '405'), ('376', '338'), ('376', '363'), ('376', '356'), ('376', '424'), ('376', '386'), ('376', '314'), ('376', '335'), ('376', '408'), ('376', '342'), ('376', '321'), ('376', '398'), ('376', '392'), ('376', '345'), ('376', '423'), ('376', '351'), ('376', '326'), ('376', '395'), ('376', '381'), ('376', '348'), ('376', '402'), ('376', '364'), ('376', '416'), ('376', '370'), ('376', '332'), ('376', '369'), ('376', '307'), ('376', '297'), ('376', '318'), ('376', '404'), ('376', '410'), ('376', '343'), ('376', '376'), ('376', '357'), ('376', '339'), ('376', '315'), ('376', '301'), ('376', '334'), ('376', '409'), ('376', '387'), ('376', '309'), ('376', '320'), ('376', '367'), ('376', '401'), ('376', '373'), ('376', '415'), ('376', '420'), ('376', '328'), ('376', '418'), ('376', '352'), ('376', '331'), ('376', '382'), ('376', '346'), ('376', '310'), ('376', '396'), ('376', '389'), ('376', '325'), ('376', '340'), ('376', '304'), ('376', '354'), ('376', '375'), ('376', '407'), ('376', '361'), ('376', '384'), ('376', '390'), ('376', '323'), ('376', '299'), ('376', '378'), ('376', '359'), ('376', '302'), ('376', '316'), ('376', '400'), ('376', '414'), ('376', '366'), ('376', '329'), ('376', '372'), ('376', '308'), ('376', '353'), ('376', '421'), ('376', '305'), ('376', '311'), ('376', '419'), ('376', '397'), ('376', '355'), ('376', '341'), ('376', '388'), ('376', '324'), ('376', '383'), ('376', '406'), ('376', '360'), ('376', '412'), ('376', '281'), ('376', '358'), ('376', '336'), ('376', '322'), ('376', '391'), ('376', '374'), ('376', '379'), ('376', '385'), ('376', '317'), ('376', '298'), ('376', '303')]
    # missing_val = [('376', '300'), ('376', '393'), ('376', '337')]
    # missing_test = [('376', '306'), ('376', '394'), ('376', '313'), ('376', '362'), ('376', '413'), ('376', '047'), ('376', '347'), ('376', '330')]

    missings_sorted_uttr = sorted(missings, key=lambda miss: miss[1])
    missings_sorted = sorted(missings_sorted_uttr, key=lambda miss: miss[0])
    print(missings_sorted)
    # [('361', '131'), ('376', '047'), ('376', '062'), ('376', '281'), ('376', '296'), ('376', '297'), ('376', '298'), ('376', '299'), ('376', '300'), ('376', '301'), ('376', '302'), ('376', '303'), ('376', '304'), ('376', '305'), ('376', '306'), ('376', '307'), ('376', '308'), ('376', '309'), ('376', '310'), ('376', '311'), ('376', '312'), ('376', '313'), ('376', '314'), ('376', '315'), ('376', '316'), ('376', '317'), ('376', '318'), ('376', '319'), ('376', '320'), ('376', '321'), ('376', '322'), ('376', '323'), ('376', '324'), ('376', '325'), ('376', '326'), ('376', '327'), ('376', '328'), ('376', '329'), ('376', '330'), ('376', '331'), ('376', '332'), ('376', '333'), ('376', '334'), ('376', '335'), ('376', '336'), ('376', '337'), ('376', '338'), ('376', '339'), ('376', '340'), ('376', '341'), ('376', '342'), ('376', '343'), ('376', '344'), ('376', '345'), ('376', '346'), ('376', '347'), ('376', '348'), ('376', '349'), ('376', '350'), ('376', '351'), ('376', '352'), ('376', '353'), ('376', '354'), ('376', '355'), ('376', '356'), ('376', '357'), ('376', '358'), ('376', '359'), ('376', '360'), ('376', '361'), ('376', '362'), ('376', '363'), ('376', '364'), ('376', '365'), ('376', '366'), ('376', '367'), ('376', '368'), ('376', '369'), ('376', '370'), ('376', '371'), ('376', '372'), ('376', '373'), ('376', '374'), ('376', '375'), ('376', '376'), ('376', '377'), ('376', '378'), ('376', '379'), ('376', '380'), ('376', '381'), ('376', '382'), ('376', '383'), ('376', '384'), ('376', '385'), ('376', '386'), ('376', '387'), ('376', '388'), ('376', '389'), ('376', '390'), ('376', '391'), ('376', '392'), ('376', '393'), ('376', '394'), ('376', '395'), ('376', '396'), ('376', '397'), ('376', '398'), ('376', '399'), ('376', '400'), ('376', '401'), ('376', '402'), ('376', '403'), ('376', '404'), ('376', '405'), ('376', '406'), ('376', '407'), ('376', '408'), ('376', '409'), ('376', '410'), ('376', '411'), ('376', '412'), ('376', '413'), ('376', '414'), ('376', '415'), ('376', '416'), ('376', '417'), ('376', '418'), ('376', '419'), ('376', '420'), ('376', '421'), ('376', '422'), ('376', '423'), ('376', '424')]


if __name__ == '__main__':
    generate_fixed_data()
